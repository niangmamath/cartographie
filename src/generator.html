
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Générateur de Cartographie d'Entreprise par IA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    html { height: 100%; }
    body {
        height: 100%;
        overflow: hidden;
        background-color: #f8f9fa;
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    .main-layout { display: flex; height: 100vh; width: 100vw; }
    .form-panel {
        width: 450px;
        padding: 2rem;
        flex-shrink: 0;
        overflow-y: auto;
        background-color: #ffffff;
        border-right: 1px solid #dee2e6;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        z-index: 10;
        transition: width 0.3s ease;
    }
    .form-panel .h3 {
        font-weight: 700;
        color: #212529;
    }
    .map-panel {
        flex-grow: 1;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    #map-container {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        overflow: hidden;
        background-color: #ffffff;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.03);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
    }
    .placeholder-content {
        color: #6c757d;
        text-align: center;
        max-width: 400px;
    }
    .placeholder-content svg {
        width: 50px;
        height: 50px;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    #map-container > svg, #map-container .mermaid > svg {
        max-width: none;
        max-height: none;
        border-radius: 12px;
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
    }
    .btn {
        padding: 0.75rem 1rem;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.2s ease-in-out;
    }
    .btn-primary {
        background-color: #0d6efd;
        border: none;
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(13, 110, 253, 0.2);
    }
    .form-control, .form-select {
        border-radius: 8px;
        padding: 0.75rem;
    }
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        border-color: #86b7fe;
    }

    @media (max-width: 768px) {
        html, body { height: auto; overflow: auto; }
        .main-layout { flex-direction: column; height: auto; }
        .form-panel {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #dee2e6;
            height: auto;
            overflow-y: visible;
            box-shadow: none;
        }
        .map-panel {
            height: 80vh;
            padding: 1rem 0.5rem;
        }
        #map-container {
            overflow: auto;
        }
    }
  </style>
</head>
<body>
  <div class="main-layout">
    <div class="form-panel">
      <h3 class="mb-4 h3">Cartographie par IA</h3>
      <form id="map-form">
        <div class="mb-3">
          <label for="map_type" class="form-label">1. Choisissez le type de cartographie :</label>
          <select class="form-select" id="map_type" name="map_type">
            <optgroup label="Processus">
              <option value="processus_flux">Diagramme de Flux</option>
              <option value="processus_mental">Carte Mentale</option>
            </optgroup>
            <optgroup label="Organisationnelle">
              <option value="organisationnelle_flux">Diagramme de Relations</option>
              <option value="organisationnelle_mental">Carte Mentale</option>
            </optgroup>
            <optgroup label="Applicative">
              <option value="applicative_flux">Flux d'Intégration</option>
              <option value="applicative_mental">Carte Mentale</option>
            </optgroup>
            <optgroup label="Données">
              <option value="donnees_flux">Flux de Données</option>
              <option value="donnees_mental">Carte Mentale</option>
            </optgroup>
            <optgroup label="Risques">
              <option value="risques_flux">Diagramme de Causalité</option>
              <option value="risques_mental">Carte Mentale</option>
            </optgroup>
          </select>
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">2. Décrivez votre entreprise ou projet :</label>
          <textarea class="form-control" id="description" name="description" rows="6" placeholder="Exemple : Une plateforme e-commerce de vente de café en grains." required></textarea>
        </div>
        <div class="d-grid gap-2 mt-4">
          <button type="submit" id="generate-btn" class="btn btn-primary">Générer la Cartographie</button>
          <button type="button" id="download-svg-btn" class="btn btn-secondary" style="display: none;">Télécharger en SVG</button>
        </div>
      </form>
    </div>
    <div class="map-panel">
      <div id="map-container">
        <div class="placeholder-content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15zM21 21l-5.2-5.2" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.5A6.5 6.5 0 1112 5.5" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8.5v4l2 2" /></svg>
            <h4 class="mt-3 fw-bold">Votre Espace de Visualisation</h4>
            <p class="text-muted">Remplissez le formulaire et cliquez sur "Générer" pour donner vie à votre cartographie ici.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4/dist/browser/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.0/dist/mermaid.min.js"></script>

  <script>
    mermaid.initialize({ startOnLoad: false, theme: 'base', themeVariables: { 'primaryColor': '#0d6efd', 'lineColor': '#333', 'textColor': '#333' } });

    document.addEventListener('DOMContentLoaded', function () {
      const { Transformer, Markmap } = window.markmap;
      const transformer = new Transformer();

      const mapForm = document.getElementById("map-form");
      const mapContainer = document.getElementById("map-container");
      const generateBtn = document.getElementById("generate-btn");
      const downloadSvgBtn = document.getElementById("download-svg-btn");
      let markmapInstance = null;

      mapForm.addEventListener("submit", async function(event) {
        event.preventDefault();

        mapContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Génération...</span></div></div>';
        generateBtn.disabled = true;
        downloadSvgBtn.style.display = 'none';

        if (markmapInstance) {
          markmapInstance.destroy();
          markmapInstance = null;
        }

        try {
          const formData = new URLSearchParams(new FormData(mapForm));
          const response = await fetch("/generate", { method: "POST", body: formData });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erreur inconnue du serveur.');
          }
          
          const data = await response.json();
          const { map: diagramData, type: diagramType } = data;

          if (!diagramData || diagramData.trim() === '') {
            throw new Error("La réponse de l'IA est vide ou invalide.");
          }

          mapContainer.innerHTML = '';

          if (diagramType === 'mermaid') {
            const mermaidContainer = document.createElement('div');
            mermaidContainer.className = 'mermaid';
            mermaidContainer.textContent = diagramData;
            mapContainer.appendChild( mermaidContainer );
            await mermaid.run({ nodes: [mermaidContainer] });
          } else { // markmap
            const { root } = transformer.transform(diagramData);
            const svgEl = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svgEl.style.width = '100%';
            svgEl.style.height = '100%';
            mapContainer.appendChild(svgEl);
            markmapInstance = Markmap.create(svgEl, { autoFit: true, nodeShape: 'rect', toolbar: true }, root);
          }

          downloadSvgBtn.style.display = 'block';

        } catch (error) {
          console.error("An error occurred:", error);
          mapContainer.innerHTML = `<div class="alert alert-danger m-3"><b>Erreur :</b> ${error.message}</div>`;
        } finally {
          generateBtn.disabled = false;
        }
      });

      downloadSvgBtn.addEventListener("click", function() {
        const svgEl = mapContainer.querySelector('svg');
        if (!svgEl) return alert("Aucun diagramme à télécharger.");

        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(svgEl);
        const blob = new Blob(['<?xml version="1.0" standalone="no"?>\r\n' + svgString], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `cartographie_${document.getElementById("map_type").value}.svg`;
        a.click();
        URL.revokeObjectURL(url);
      });

    });
  </script>
</body>
</html>
